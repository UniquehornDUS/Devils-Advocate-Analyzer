<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devil's Advocate Analyzer</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Hilfsfunktionen ---
        const convertFileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const dataUrl = reader.result;
                    const base64Data = dataUrl.split(',')[1];
                    resolve({ base64Data, mimeType: file.type });
                };
                reader.onerror = reject;
            });
        };

        // --- Haupt-App ---
        function App() {
            const [apiKey, setApiKey] = useState("");
            const [thesisText, setThesisText] = useState("");
            const [chartImage, setChartImage] = useState(null);
            const [chartPreview, setChartPreview] = useState(null);
            const [devilResponse, setDevilResponse] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);

            // API Key aus LocalStorage laden (Komfort)
            useEffect(() => {
                const storedKey = localStorage.getItem("gemini_api_key");
                if (storedKey) setApiKey(storedKey);
            }, []);

            // API Key speichern
            const handleApiKeyChange = (e) => {
                const key = e.target.value;
                setApiKey(key);
                localStorage.setItem("gemini_api_key", key);
            };

            const processImageFile = (file) => {
                if (file && file.type.startsWith('image/')) {
                    setChartImage(file);
                    setError(null);
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onloadend = () => setChartPreview(reader.result);
                } else {
                    setError("Bitte eine gÃ¼ltige Bilddatei hochladen.");
                }
            };

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files[0]) processImageFile(e.target.files[0]);
            };

            const handleSubmit = async () => {
                if (!apiKey) {
                    setError("Bitte gib zuerst einen API Key ein.");
                    return;
                }
                if (!chartImage || !thesisText.trim()) {
                    setError("Bitte Chart hochladen UND These beschreiben.");
                    return;
                }

                setIsLoading(true);
                setError(null);
                setDevilResponse("");

                try {
                    const { base64Data, mimeType } = await convertFileToBase64(chartImage);
                    
                    const systemPrompt = `
Du bist 'Des Teufels Advokat', ein extrem skeptischer Finanzanalyst.
Widerlege die These des Traders. Sei direkt, zynisch und professionell.
Analysiere den Chart (Bild) und die These (Text).
Suche nach bÃ¤rischen Mustern, BestÃ¤tigungsfehlern und Risiken.
Beginne IMMER mit: 'Hier ist, was Sie Ã¼bersehen...'
Antworte in kurzen, harten Stichpunkten.
                    `.trim();

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            contents: [{
                                role: "user",
                                parts: [
                                    { text: `Meine These: "${thesisText}"` },
                                    { inlineData: { mimeType: mimeType, data: base64Data } }
                                ]
                            }]
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error?.message || "API Fehler");
                    
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        setDevilResponse(text);
                    } else {
                        throw new Error("Keine Antwort von der KI erhalten.");
                    }

                } catch (err) {
                    setError(`Fehler: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="max-w-3xl mx-auto p-4 md:p-8">
                    <header className="mb-8 text-center">
                        <h1 className="text-3xl md:text-4xl font-extrabold text-slate-800 mb-2">ðŸ‘¿ Devil's Advocate Analyzer</h1>
                        <p className="text-slate-600">Lass deine Trading-Idee grillen, bevor der Markt es tut.</p>
                    </header>

                    <div className="bg-white rounded-xl shadow-xl p-6 space-y-6">
                        
                        {/* API Key Input */}
                        <div className="p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <label className="block text-sm font-bold text-blue-800 mb-1">ðŸ”‘ Google Gemini API Key</label>
                            <input 
                                type="password" 
                                value={apiKey}
                                onChange={handleApiKeyChange}
                                placeholder="FÃ¼ge hier deinen API Key ein (wird lokal gespeichert)"
                                className="w-full p-2 border border-blue-200 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                            />
                            <p className="text-xs text-blue-600 mt-1">
                                BenÃ¶tigt fÃ¼r die Analyse. <a href="https://aistudio.google.com/app/apikey" target="_blank" className="underline font-bold">Hier Key holen</a> (kostenlos).
                            </p>
                        </div>

                        {/* Chart Upload */}
                        <div className="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:bg-slate-50 transition-colors relative">
                            {chartPreview ? (
                                <div className="relative inline-block">
                                    <img src={chartPreview} alt="Chart" className="max-h-64 rounded shadow-md" />
                                    <button onClick={() => {setChartImage(null); setChartPreview(null);}} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold">Ã—</button>
                                </div>
                            ) : (
                                <div>
                                    <div className="text-4xl mb-2">ðŸ“ˆ</div>
                                    <p className="text-slate-500 font-medium mb-2">Chart Bild hierher ziehen</p>
                                    <input type="file" onChange={handleFileChange} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200"/>
                                </div>
                            )}
                        </div>

                        {/* Text Input */}
